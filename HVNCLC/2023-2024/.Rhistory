if (missing(index)) {
stop("argument 'index' is not provided", call. = FALSE)
}
url <- URLencode(paste0(host, "/", index,
"/_data?format=csv&size=", size,
"&source_content_type=application/json",
"&source=", post_body))
df <- data.table::fread(url, quote = "\"",
colClasses = "character", data.table = FALSE,
showProgress = FALSE, ...)
df
}
productdb <- download_es_data("biz_register_product")
companydb <- productdb %>%
distinct(biz_tax, .keep_all = TRUE) %>%
select(biz_tax, company_name, biz_add, contact_email, contact_phone)
###Get M report structure 2021
ggs_M_report_structure <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=287602844"
M_report_structure <-  read.csv(text = gsheet2text(ggs_M_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE) %>%
select(industry_certi_code_r, hvn_survey_id_r, hvn_product_id_r, hvn_survey_keymerge, hvn_M_order)
###Get & join certificate code 2021
ggs_industry_certi_code <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=923897406"
industry_certi_code <-  read.csv(text = gsheet2text(ggs_industry_certi_code, format = 'csv'), fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = TRUE, skip = 3, colClasses = "character")
# This script aim to create market report for HVNCLC 2020
# Purpose      :   Create market report for HVNCLC 2020
# Code         :
# Destination  :   [HVNCLC] Báo cáo TT thị trường khảo sát HVNCLC 2020 (S621)
# Author       :   rta_xuanle
# Editor       :
# Created      :   2019-01-13
# Updated      :   2019-
# Change       :
## IMPORT END - Do not remove or edit this line
## -----------------------------------------------------------------------------
## global setup
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE, comment = "", message = FALSE, warning = FALSE)
options(shiny.sanitize.errors = FALSE, scipen = 999, knitr.kable.NA = "")
Sys.setlocale(category = "LC_ALL", locale = "en_US.UTF-8")
## -----------------------------------------------------------------------------
## load packages
RTA::load_packages(readr, tidyr, dplyr, DT, RTA,
stringr, gsheet, data.table, lubridate)
## -----------------------------------------------------------------------------
download_es_data <- function(index, post_body = "{}", host = "https://es.rta.vn", size = 10000, ...) {
if (missing(index)) {
stop("argument 'index' is not provided", call. = FALSE)
}
url <- URLencode(paste0(host, "/", index,
"/_data?format=csv&size=", size,
"&source_content_type=application/json",
"&source=", post_body))
df <- data.table::fread(url, quote = "\"",
colClasses = "character", data.table = FALSE,
showProgress = FALSE, ...)
df
}
productdb <- download_es_data("biz_register_product")
companydb <- productdb %>%
distinct(biz_tax, .keep_all = TRUE) %>%
select(biz_tax, company_name, biz_add, contact_email, contact_phone)
###Get M report structure 2021
ggs_M_report_structure <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=287602844"
M_report_structure <-  read.csv(text = gsheet2text(ggs_M_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE) %>%
select(industry_certi_code_r, hvn_survey_id_r, hvn_product_id_r, hvn_survey_keymerge, hvn_M_order)
###Get & join certificate code 2021
ggs_industry_certi_code <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=923897406"
industry_certi_code <-  read.csv(text = gsheet2text(ggs_industry_certi_code, format = 'csv'), fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = TRUE, skip = 3, colClasses = "character")
## e-form: https://vndemo.rtworkspace.com/webapp/webform/indexV2?familyCode=mwejjzRdt9xAsvr
## xlsform: https://drive.google.com/drive/folders/1OCY9tXmACI_YyMzMMyuQJRLpwgHHk81L
###Get instance list to delete as per BSA request
ggs_voteonline_delete <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=1158660739"
voteonline_delete <-  read.csv(text = gsheet2text(ggs_voteonline_delete, format = 'csv'), fileEncoding = "UTF-8", stringsAsFactors = FALSE)
ggs_voteonline_check_khop <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=660874130"
voteonline_check_khop <-  read.csv(text = gsheet2text(ggs_voteonline_check_khop, format = 'csv'), fileEncoding = "UTF-8", stringsAsFactors = FALSE)
## import data (repeats)
voteonline_survey_product_raw <- get_dm2_data("C1102", "HVN_PRODUCT_VOTE_2023_hvn_choice_rr_official", encoding = "UTF-8") %>%
anti_join(voteonline_delete, by = "instanceID")
## import core data
voteonline_survey_raw <- get_dm2_data("C1102", "HVN_PRODUCT_VOTE_2023_official_CORE") %>%
anti_join(voteonline_delete, by = "instanceID")
## progress data
voteonline_data <- voteonline_survey_raw %>%
filter(!is.na(instanceID) & instanceID != "") %>%
mutate(date = substr(starttime, 1, 10),
fullname = capwords(fullname, strict = TRUE)) %>%
select(instanceID, hvn_survey_id, hvn_survey_lb, starttime_str, submission_date, hvn_screening,
hvn_res_name, hvn_res_gender, hvn_res_gender_lb, hvn_res_age,
hvn_res_edu, hvn_res_edu_lb, hvn_res_income, hvn_res_income_lb, hvn_res_job, hvn_res_job_lb,
hvn_city_id, hvn_city_lb, hvn_district_lb, hvn_commune_lb, hvnadd_detail, hvn_phone, hvn_email, username, fullname,
hvn_m_interest_1, hvn_m_interest_2, hvn_m_interest_3,
hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb,
hvn_m_buy_place_1, hvn_m_buy_place_2, hvn_m_buy_place_3,
hvn_m_info_source_1, hvn_m_info_source_2, hvn_m_info_source_3)
voteonline_data_progress_report <- voteonline_data %>%
select(instanceID, starttime_str, submission_date, hvn_screening,
hvn_res_name, hvn_res_gender, hvn_res_gender_lb, hvn_res_age,
hvn_res_edu, hvn_res_edu_lb, hvn_res_income, hvn_res_income_lb, hvn_res_job, hvn_res_job_lb,
hvn_city_id, hvn_city_lb, hvn_district_lb, hvn_commune_lb, hvnadd_detail, hvn_phone, hvn_email,
username, fullname, hvn_survey_id, hvn_survey_lb)
voteonline_survey_product <- voteonline_survey_product_raw %>%
separate_rows(biz_tax, sep = " ") %>%
mutate(instanceID_sub = paste0(instanceID, "_", biz_tax),
hvn_tax_code = biz_tax) %>%
rename(hvn_product_id = hvn_option_id,
hvn_product_lb = hvn_option_lb) %>%
select(instanceID_sub, instanceID, hvn_position2, biz_tax, hvn_tax_code,
hvn_product_id, hvn_product_lb) %>%
mutate(hvn_product_id = case_when(
str_length(hvn_product_id) == 3 ~ paste0("0", hvn_product_id),
TRUE ~ hvn_product_id),
hvn_tax_code = case_when(str_length(hvn_tax_code) == 9 ~ paste0("0", hvn_tax_code),
TRUE ~ hvn_tax_code))
#I add this to by pass error using old command
voteonline_data_full <- voteonline_data  %>%
left_join(voteonline_survey_product, by = "instanceID", multiple = "all") %>%
mutate(hvn_res_name = capwords(hvn_res_name, strict = TRUE)) %>%
filter(!(is.na(hvn_product_id) | hvn_product_id == "")) %>%
left_join(industry_certi_code, by = "hvn_product_id", multiple = "all")  %>%
left_join(companydb, by = "biz_tax") %>%
mutate(hvn_brand_name = company_name)
voteonline_data_product_progress_report <- voteonline_data_full %>%
left_join(companydb, by = "biz_tax") %>%
select(instanceID, username, fullname, hvn_res_name, hvn_position2, hvn_product_id, hvn_product_lb,
hvn_tax_code, hvn_brand_name,
hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb,
hvn_m_buy_place_1, hvn_m_buy_place_2, hvn_m_buy_place_3,
hvn_m_info_source_1, hvn_m_info_source_2, hvn_m_info_source_3)
## e-form: https://vndemo.rtworkspace.com/webapp/webform/indexV2?familyCode=hCvCT5E5BsnXY3w
## xlsform: https://drive.google.com/drive/folders/1Spmmbe9Mo4xCwjOv2We2Dyd9tNuf-Er5
##Get instance list to delete as per BSA request
ggs_voteoffline_delete <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=1167862759"
voteoffline_delete <-  read.csv(text = gsheet2text(ggs_voteoffline_delete, format = 'csv'), fileEncoding = "UTF-8", stringsAsFactors = FALSE)
## import data (repeats)
voteoffline_survey_product_raw <- get_dm2_data("C1102", "HVN_PRODUCT_VOTEOFF_2023_hvn_choice_rr_official", encoding = "UTF-8") %>%
anti_join(voteoffline_delete, by = "instanceID")
## import core data
voteoffline_survey_raw <- get_dm2_data("C1102", "HVN_PRODUCT_VOTEOFF_2023_official_CORE") %>%
anti_join(voteoffline_delete, by = "instanceID") %>%
group_by(orig_inst) %>%
arrange(desc(endtime)) %>%
ungroup() %>%
distinct(orig_inst, .keep_all = TRUE)
## progress data
voteoffline_data <- voteoffline_survey_raw %>%
filter(!is.na(instanceID) & instanceID != "") %>%
mutate(date = substr(starttime, 1, 10),
fullname = capwords(fullname, strict = TRUE)) %>%
select(instanceID, hvn_survey_id, hvn_survey_lb, starttime_str, submission_date, hvn_screening,
hvn_res_name, hvn_res_gender, hvn_res_gender_lb, hvn_res_age,
hvn_res_edu, hvn_res_edu_lb, hvn_res_income, hvn_res_income_lb, hvn_res_job, hvn_res_job_lb,
hvn_city_id, hvn_city_lb, hvn_district_lb, hvn_commune_lb, hvnadd_detail, hvn_phone, hvn_email, username, fullname,
hvn_m_interest_1, hvn_m_interest_2, hvn_m_interest_3,
hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb,
hvn_m_buy_place_1, hvn_m_buy_place_2, hvn_m_buy_place_3,
hvn_m_info_source_1, hvn_m_info_source_2, hvn_m_info_source_3)
voteoffline_data_progress_report <- voteoffline_data %>%
select(instanceID, starttime_str, submission_date, hvn_screening,
hvn_res_name, hvn_res_gender, hvn_res_gender_lb, hvn_res_age,
hvn_res_edu, hvn_res_edu_lb, hvn_res_income, hvn_res_income_lb, hvn_res_job, hvn_res_job_lb,
hvn_city_id, hvn_city_lb, hvn_district_lb, hvn_commune_lb, hvnadd_detail, hvn_phone, hvn_email,
username, fullname, hvn_survey_id, hvn_survey_lb)
voteoffline_survey_product <- voteoffline_survey_product_raw %>%
separate_rows(biz_tax, sep = " ") %>%
mutate(instanceID_sub = paste0(`_URI`, "_", biz_tax),
`_URI` = `_PARENT_AURI`, hvn_tax_code = biz_tax) %>%
rename(hvn_product_id = hvn_option_id,
hvn_product_lb = hvn_option_lb) %>%
select(instanceID_sub, instanceID, hvn_position2, biz_tax, hvn_tax_code,
hvn_product_id, hvn_product_lb) %>%
mutate(hvn_product_id = case_when(
str_length(hvn_product_id) == 3 ~ paste0("0", hvn_product_id),
TRUE ~ hvn_product_id),
hvn_tax_code = case_when(str_length(hvn_tax_code) == 9 ~ paste0("0", hvn_tax_code),
TRUE ~ hvn_tax_code))
#I add this to by pass error using old command
voteoffline_data_full <- voteoffline_data  %>%
left_join(voteoffline_survey_product, by = "instanceID", multiple = "all") %>%
mutate(hvn_res_name = capwords(hvn_res_name, strict = TRUE)) %>%
filter(!(is.na(hvn_product_id) | hvn_product_id == "")) %>%
left_join(industry_certi_code, by = "hvn_product_id", multiple = "all") %>%
left_join(companydb, by = "biz_tax") %>%
mutate(hvn_brand_name = company_name)
voteoffline_data_product_progress_report <- voteoffline_data_full %>%
left_join(companydb, by = "biz_tax") %>%
select(instanceID, username, fullname, hvn_res_name, hvn_position2, hvn_product_id, hvn_product_lb,
hvn_tax_code, hvn_brand_name,
hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb,
hvn_m_buy_place_1, hvn_m_buy_place_2, hvn_m_buy_place_3,
hvn_m_info_source_1, hvn_m_info_source_2, hvn_m_info_source_3)
data_full <- rbind(voteoffline_data_full, voteonline_data_full)
mp_data <- data_full %>%
filter(!duplicated(instanceID)) %>%
mutate(hvn_survey_id_num = as.numeric(hvn_survey_id))
data_long <- gather(map37mp, source, industry_certi_name_eform, hvn_m_interest_1_lb:hvn_m_interest_3_lb,
factor_key=TRUE) %>%
distinct(hvn_survey_id, industry_certi_name_eform)
map37mp <- data_full %>%
select(hvn_survey_id, hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb)
data_long <- gather(map37mp, source, industry_certi_name_eform, hvn_m_interest_1_lb:hvn_m_interest_3_lb,
factor_key=TRUE) %>%
distinct(hvn_survey_id, industry_certi_name_eform)
View(data_long)
data_long <- gather(map37mp, source, industry_certi_name_eform, hvn_m_interest_1_lb:hvn_m_interest_3_lb,
factor_key=TRUE) %>%
distinct(hvn_survey_id, industry_certi_name_eform) %>%
filter(str_length(industry_certi_name_eform) > 1)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform")
map37mp <- data_full %>%
select(hvn_survey_id, hvn_m_interest_1_lb, hvn_m_interest_2_lb, hvn_m_interest_3_lb)
data_long <- gather(map37mp, source, industry_certi_name_eform, hvn_m_interest_1_lb:hvn_m_interest_3_lb,
factor_key=TRUE) %>%
distinct(hvn_survey_id, industry_certi_name_eform) %>%
filter(str_length(industry_certi_name_eform) > 1)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
View(db_37mplb)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform")
View(temp)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
ggs_37mp <- "https://docs.google.com/spreadsheets/d/1LTNl1syM0WCPuJ2VHBtgds82cZWGVsKCOFBPAmpDn-o/edit#gid=711145776"
db_37mplb <-  read.csv(text = gsheet2text(ggs_37mp, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 30)
temp <- full_join(db_37mplb, data_long, by = "industry_certi_name_eform") %>%
arrange(industry_certi_name_eform)
View(data_long)
install.packages("av")
RTA::load_packages(readr, tidyr, dplyr, DT, RTA, shiny,
stringr, gsheet, data.table, lubridate, openxlsx, downloadthis)
# Get RDS
git_path <- "https://rtgit.rta.vn/rta_trungle/rtpublic/-/raw/main/HVNCLC/2023-2024/"
productdb <- readRDS(url(paste0(git_path,"productdb.rds"),"rb"))
productdb <- readRDS(url(paste0(git_path,"productdb.rds"),"rb"))
companydb <- readRDS(url(paste0(git_path,"companydb.rds"),"rb"))
industry_certi_code <- readRDS(url(paste0(git_path,"industry_certi_code.rds"),"rb"))
industry_certi_code <- readRDS(url(paste0(git_path,"industry_certi_code.rds"),"rb"))
MauKS37NganhCN_report_structure <- readRDS(url(paste0(git_path,"MauKS37NganhCN_report_structure.rds"),"rb"))
Report_ty_le_ghi_nhan_DN_Option_1_report_structure <- readRDS(url(paste0(git_path,"Report_ty_le_ghi_nhan_DN_Option_1_report_structure.rds"),"rb"))
retailer_data_full_ranking <- readRDS(url(paste0(git_path,"retailer_data_full_ranking.rds"),"rb"))
adv_choices <- readRDS(url(paste0(git_path,"adv_choices.rds"),"rb"))
m3_choices <- readRDS(url(paste0(git_path,"m3_choices.rds"),"rb"))
m4_choices <- readRDS(url(paste0(git_path,"m4_choices.rds"),"rb"))
m5_choices <- readRDS(url(paste0(git_path,"m5_choices.rds"),"rb"))
rm6_choices <- readRDS(url(paste0(git_path,"rm6_choices.rds"),"rb"))
rm7_choices <- readRDS(url(paste0(git_path,"rm7_choices.rds"),"rb"))
rm8_choices <- readRDS(url(paste0(git_path,"rm8_choices.rds"),"rb"))
rm9_choices <- readRDS(url(paste0(git_path,"rm9_choices.rds"),"rb"))
db27svy_37ind <- readRDS(url(paste0(git_path,"db27svy_37ind.rds"),"rb"))
# https://docs.google.com/spreadsheets/d/1qjozyoq4nF7Zl4K5vKnfbi9UTzmrLqgxg6CiuZqGukc/edit#gid=968001911
# first get the product group label. Note that hvn_m_interest_?_lb are used to map with cert codes
rm7_data <- retailer_data_full_ranking %>%
distinct(instanceID, .keep_all = TRUE) %>%
rename(hvn_survey_id = hvn_survey_id_mp,
industry_certi_code = industry_certi_code_mp,
hvn_m_interest = hvn_m7) %>%
distinct(instanceID, .keep_all = TRUE) %>%
separate_rows(hvn_m_interest, sep = " ") %>%
filter(str_length(hvn_m_interest) > 0) %>%
distinct(instanceID, hvn_m_interest, .keep_all = TRUE) %>%
left_join(rm7_choices, by = c("hvn_m_interest" = "choice_id")) %>%
mutate(hvn_survey_id_num = as.numeric(hvn_survey_id)) %>%
group_by(hvn_survey_id, industry_certi_code) %>%
mutate(group_male = n_distinct(instanceID_G1,  na.rm = TRUE),
group_female = n_distinct(instanceID_G2,  na.rm = TRUE),
group_retype1 = n_distinct(instanceID_T1,  na.rm = TRUE),
group_retype2 = n_distinct(instanceID_T2,  na.rm = TRUE),
group_retype3 = n_distinct(instanceID_T3,  na.rm = TRUE),
group_retype4 = n_distinct(instanceID_T4,  na.rm = TRUE),
group_city1 = n_distinct(instanceID_C1,  na.rm = TRUE),
group_city2 = n_distinct(instanceID_C2,  na.rm = TRUE),
group_city3 = n_distinct(instanceID_C3,  na.rm = TRUE),
group_city4 = n_distinct(instanceID_C4,  na.rm = TRUE),
group_city5 = n_distinct(instanceID_C5,  na.rm = TRUE),
group_total = n_distinct(instanceID,  na.rm = TRUE)) %>%
ungroup() %>%
filter(hvn_m_interest != "choice_id")
#### Create table rm7
rm7_detail <- rm7_data %>%
select(starts_with("instanceID"), hvn_survey_id, hvn_survey_id_num, industry_certi_code,
hvn_m_interest, group_male, group_female, group_total) %>%
group_by(hvn_survey_id, industry_certi_code, hvn_m_interest) %>%
mutate(n_total = n_distinct(instanceID,  na.rm = TRUE)) %>%
ungroup() %>%
distinct(hvn_survey_id, industry_certi_code, hvn_m_interest, .keep_all = TRUE) %>%
mutate(total_p = round(n_total / group_total, 4) * 100
) %>%
arrange(as.numeric(hvn_survey_id, industry_certi_code, hvn_m_interest))
rm7 <- rm7_detail %>%
group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
summarise(n_total = sum(n_total, na.rm = TRUE),
group_total = sum(group_total, na.rm = TRUE)) %>%
ungroup() %>%
mutate(total_p = round(n_total / group_total, 4) * 100
) %>%
mutate(hvn_survey_id = case_when(hvn_survey_id_num==11 & industry_certi_code==13 ~ "Total_",
hvn_survey_id_num==15 & industry_certi_code==21 ~ "Total_",
TRUE ~ "Total")) %>%
bind_rows(rm7_detail) %>%
select(hvn_survey_id, hvn_survey_id_num, industry_certi_code,
hvn_m_interest,
group_total, n_total, total_p) %>%
#group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
#mutate(industry_certi_code = mean(industry_certi_code, na.rm = TRUE)) %>%
mutate(choice_id = as.numeric(hvn_m_interest),
industry_certi_code = as.numeric(industry_certi_code)) %>%
#ungroup() %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
full_join(RM7_report_structure, by = c("industry_certi_code", "hvn_survey_id", "choice_id")) %>%
filter(is.na(stt) == FALSE) %>%
distinct(stt, .keep_all = TRUE) %>%
arrange(stt)
RM7_report_structure <- readRDS(url(paste0(git_path,"RM7_report_structure.rds"),"rb"))
RM7_report_structure <- readRDS(url(paste0(git_path,"RM7_report_structure.rds"),"rb"))
RM8_report_structure <- readRDS(url(paste0(git_path,"RM8_report_structure.rds"),"rb"))
RM8_report_structure <- readRDS(url(paste0(git_path,"RM8_report_structure.rds"),"rb"))
RM9_report_structure <- readRDS(url(paste0(git_path,"RM9_report_structure.rds"),"rb"))
rm7 <- rm7_detail %>%
group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
summarise(n_total = sum(n_total, na.rm = TRUE),
group_total = sum(group_total, na.rm = TRUE)) %>%
ungroup() %>%
mutate(total_p = round(n_total / group_total, 4) * 100
) %>%
mutate(hvn_survey_id = case_when(hvn_survey_id_num==11 & industry_certi_code==13 ~ "Total_",
hvn_survey_id_num==15 & industry_certi_code==21 ~ "Total_",
TRUE ~ "Total")) %>%
bind_rows(rm7_detail) %>%
select(hvn_survey_id, hvn_survey_id_num, industry_certi_code,
hvn_m_interest,
group_total, n_total, total_p) %>%
#group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
#mutate(industry_certi_code = mean(industry_certi_code, na.rm = TRUE)) %>%
mutate(choice_id = as.numeric(hvn_m_interest),
industry_certi_code = as.numeric(industry_certi_code)) %>%
#ungroup() %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
full_join(RM7_report_structure, by = c("industry_certi_code", "hvn_survey_id", "choice_id")) %>%
filter(is.na(stt) == FALSE) %>%
distinct(stt, .keep_all = TRUE) %>%
arrange(stt)
table_rm7 <- rm7 %>%
select(hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name,
choice_id, choice_name,
group_total, n_total, total_p)
View(table_rm7)
View(table_rm7)
View(rm7_detail)
View(rm7)
rm7 <- rm7_detail %>%
group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
summarise(n_total = sum(n_total, na.rm = TRUE),
group_total = sum(group_total, na.rm = TRUE)) %>%
ungroup() %>%
mutate(total_p = round(n_total / group_total, 4) * 100
) %>%
mutate(hvn_survey_id = case_when(hvn_survey_id_num==11 & industry_certi_code==13 ~ "Total_",
hvn_survey_id_num==15 & industry_certi_code==21 ~ "Total_",
TRUE ~ "Total")) %>%
bind_rows(rm7_detail) %>%
select(hvn_survey_id, hvn_survey_id_num, industry_certi_code,
hvn_m_interest,
group_total, n_total, total_p) %>%
#group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
#mutate(industry_certi_code = mean(industry_certi_code, na.rm = TRUE)) %>%
mutate(choice_id = as.numeric(hvn_m_interest),
industry_certi_code = as.numeric(industry_certi_code)) %>%
#ungroup() %>%
mutate(choice_id = replace_na(choice_id, 999))
View(rm7)
View(rm7)
rm7 <- rm7_detail %>%
group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
summarise(n_total = sum(n_total, na.rm = TRUE),
group_total = sum(group_total, na.rm = TRUE)) %>%
ungroup() %>%
mutate(total_p = round(n_total / group_total, 4) * 100
) %>%
mutate(hvn_survey_id = case_when(hvn_survey_id_num==11 & industry_certi_code==13 ~ "Total_",
hvn_survey_id_num==15 & industry_certi_code==21 ~ "Total_",
TRUE ~ "Total")) %>%
bind_rows(rm7_detail) %>%
select(hvn_survey_id, hvn_survey_id_num, industry_certi_code,
hvn_m_interest,
group_total, n_total, total_p) %>%
#group_by(hvn_survey_id, hvn_survey_id_num, industry_certi_code) %>%
#mutate(industry_certi_code = mean(industry_certi_code, na.rm = TRUE)) %>%
mutate(choice_id = as.numeric(hvn_m_interest),
industry_certi_code = as.numeric(industry_certi_code)) %>%
#ungroup() %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
full_join(RM7_report_structure, by = c("industry_certi_code", "hvn_survey_id", "choice_id"))
View(rm7)
ggs_RM7_report_structure <- "https://docs.google.com/spreadsheets/d/10hy1rNubjZ8TbnR8JJRQvTmaywE01U-wgvRf46AQYSM/edit#gid=1418342777"
RM7_report_structure <-  read.csv(text = gsheet2text(ggs_RM7_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 2, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number(),
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
View(RM7_report_structure)
RM7_report_structure <-  read.csv(text = gsheet2text(ggs_RM7_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, skip = 2, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number()
,
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
View(RM7_report_structure)
RM7_report_structure <-  read.csv(text = gsheet2text(ggs_RM7_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number()
,
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
View(RM7_report_structure)
RM7_report_structure <-  read.csv(text = gsheet2text(ggs_RM7_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number(),
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
saveRDS(RM7_report_structure, "RM7_report_structure.rds")
# Get report structure
setwd("/Users/ledangtrung/rtGit/rtpublic/HVNCLC/2023-2024/")
saveRDS(RM7_report_structure, "RM7_report_structure.rds")
ggs_RM8_report_structure <- "https://docs.google.com/spreadsheets/d/1V-oxUKZahxyLzUXdY-ityeR7E4BzzNzyLF7Mu7A2Wd4/edit#gid=1889520976"
RM8_report_structure <-  read.csv(text = gsheet2text(ggs_RM8_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number(),
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
saveRDS(RM8_report_structure, "RM8_report_structure.rds")
checkdup_RM8_report_structure <- RM8_report_structure %>%
group_by(hvn_survey_id, industry_certi_code, choice_id) %>%
mutate(dupe = n()>1) %>%
filter(dupe==TRUE)
ggs_RM9_report_structure <- "https://docs.google.com/spreadsheets/d/1Foa8YIG6ghWpepJ9T45Zm-tixoEjLMimN4O93gPDp6U/edit#gid=1463628984"
RM9_report_structure <-  read.csv(text = gsheet2text(ggs_RM9_report_structure, format = 'csv'),
fileEncoding = "UTF-8", stringsAsFactors = FALSE, header = FALSE) %>%
filter(row_number() > 3) %>%
mutate(stt = row_number(),
hvn_survey_id = str_remove(V1, "MP"),
hvn_survey_name = V2,
industry_certi_code = as.numeric(V3),
industry_certi_name = V4,
choice_id = as.numeric(V5),
choice_name = V6) %>%
mutate(choice_id = replace_na(choice_id, 999)) %>%
select(stt, hvn_survey_id, hvn_survey_name, industry_certi_code, industry_certi_name, choice_id, choice_name) %>%
filter(choice_name != "Có Khuyến mãi")
saveRDS(RM9_report_structure, "RM9_report_structure.rds")
